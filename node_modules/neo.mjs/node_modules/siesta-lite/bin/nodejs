#!/bin/bash

portable_readlink() (
    local TARGET_FILE="$1"

    cd $(dirname "$TARGET_FILE")
    TARGET_FILE=$(basename "$TARGET_FILE")

    # Iterate down a (possible) chain of symlinks
    while [[ -L "$TARGET_FILE" ]]
    do
        TARGET_FILE=$(readlink "$TARGET_FILE")
        cd $(dirname "$TARGET_FILE")
        TARGET_FILE=$(basename "$TARGET_FILE")
    done

    local PHYS_DIR=$(pwd -P)
    echo "$PHYS_DIR/$TARGET_FILE"
)

REALPATH=$(portable_readlink "$0")

DIR=$(dirname "$REALPATH")

which node > /dev/null 2>&1

if [ "$?" -eq "0" ]; then
    NODE_EXECUTABLE="node"
else
    echo -e "[ERROR]: NodeJS executable ('node') is not available in the PATH"

    exit 1
fi


SCRIPT_ADDED="false"
ARGS=()

for arg in "$@"
do
    arg=$1; shift;

    REGEXP="^[[:space:]]*--([[:alnum:]_-]+)(=(.*))?"

    if [[ "$arg" =~ $REGEXP ]]; then
        ARGS+=("$arg")
    else
        if [[ $SCRIPT_ADDED == "false" ]]; then
            SCRIPT_ADDED="true"
            ARGS+=("$DIR/projects/default_nodejs_project.js")
        fi

        ARGS+=("$arg")
    fi
done


if [[ $SCRIPT_ADDED == "false" ]]; then
    node "$DIR/projects/default_nodejs_project.js" "${ARGS[@]}"
else
    node "${ARGS[@]}"
fi


